---
title: "Bacterial infection"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: 72
---

# Inclusion criteria
The *patients* inclusion criteria is **patients < 18 at the date of visit**
The *Visits* inclusion criteria includes:
    -   Inpatients (at least one hospitalization \> 1 day)
    -   Comprising at least one ICD-10 code during hospitalization
    -   Start date: January 1st, 2019
    -   End date: March 31st, 2023

# Variables that need to be checked/modified by each site
Change the values of the following variables according to your site:
1.  "folder_4ce_files": folder path where your phase 2.2 data files are
    located
2.  "obfuscation": determine the obfuscation threshold (FALSE if no
    obfuscation, or the numeric value of the obfuscation threshold if
    any)
3.  "dateFormat": specify the format of the date at your site (e.g., for
    "2021-06-24", the format would be ""%Y-%m-%d"", [see
    documentation](https://www.stat.berkeley.edu/~s133/dates.html))
4.  "data_update_date": date at which the data has been updated in the
    local datawarehouse. Used to estimate patient age at time of visit,
    since patients age in the 4CE demographic file is expected the age
    at data update.
    
```{r message=FALSE, warning=FALSE}
folder_4ce_files <- "/4ceData/Input/AllAdmin2023//"
obfuscation =  FALSE
#obfuscation = 3
dateFormat <- "%Y-%m-%d"
data_update_date <- "2023-04-25"
dir.output <- "/4ceData/bacterialInfection_outputs/"
site_id <- 'BCH' ### needed?
```


# Setting up the R environment

This includes:
1. create the output directory if it does not exist 
2. create the logs file. 

```{r}
print("Creating the output folder if it doesn't exist")
if (! dir.output %in% list.dirs()) {dir.create(dir.output)}

sink(file = paste0( dir.output, "/logs_QC.txt"))
print('##########')
print(site_id)
print(timestamp())
print('##########')
```

3. installing and loading the libraries
4. set up the theme plots and color palettes 
5. get the session info 

```{r libraries, message=FALSE, warning=FALSE, results='hide'}
# Install packages
source("../R/packagesInstallation.R")
# set up the theme plots
source("../R/theme_plots.R")
# get the session information
sessionInfo()
# load the local variables
source("../R/setUpVariableParameters.R")

print(paste0( 'FourCePhase2.2bacterial Infection Code version: ', codeVersion ))
print('##########')
```

## Data loading
We will use as input the 2.2 data files. Specifically:
-   LocalPatientSummary
-   LocalPatientObservation
-   LocalPatientClinicalcourse

### Reading 4CE phase 2.2 files

```{r message=FALSE, warning=FALSE}
### Read the CSV input files
source("../R/readInputFiles.R")

print("Reading input files")
files <- readInputFiles( path      = folder_4ce_files, 
                         separator = ",",
                         skip      = 0, 
                         verbose   = FALSE )

### Extract the patient summary and observation information. 
demo_raw <- files[["patientSummary"]] %>% filter(cohort == "AllAdm")
obs_raw <- files[["patientObservations"]] %>% filter(cohort == "AllAdm")
clinical_raw <- files[["patientClinicalCourse"]] %>% filter(cohort == "AllAdm")
rm(files) # remove files object to not have unnecessary objects

print('Input files successfully read, patient data extracted')
```

### Select the specific ICD codes of interest
```{r}
#### ICD codes bacterial conditions ####
print('Reading ICD bacterial codes')
icdCodes <- read.csv("../public-data/ICD_bacterial4.csv", header = TRUE, colClasses = "character") %>%
   dplyr::mutate( concept_code = gsub("\\.", "",ICD10_Code)) %>%
   dplyr::select( disorder_group = syndrome, ICD10_Code, concept_code, description, bacterial_syndrome )
```


## Calculate how many of the bacterial infection codes are in the dataset
```{r}
bacterialInfectionCodes <- unique( obs_raw %>%
  dplyr::mutate( concept_code = gsub("[.]", "", concept_code ) ) %>%
  dplyr::filter( concept_type == "DIAG-ICD10", 
                 concept_code %in% icdCodes$concept_code ) %>%
  dplyr::mutate( concept_code = as.character( concept_code ), 
                 concept_length = nchar( concept_code ), 
                 concept_check = ifelse( concept_length == 2 | concept_length > 8, "Check", "OK")) %>%
  dplyr::select( concept_code, concept_length, concept_check) )

summary(as.factor( bacterialInfectionCodes$concept_check ) )

print( paste0("There are ", length(bacterialInfectionCodes$concept_code), " ICD10 bacterial infection codes in this site out of the total ",length(unique(icdCodes$ICD10_Code)), " in the dataset"))
```

## Data-management

### Filtering on "inpatient" status

```{r}
# Filtering on inpatients here (in_hospital == 1), to reduce subsequent compute time of the encounter length calculation 
clinical_raw <- filter(clinical_raw, in_hospital == 1)
```

### Calculating duration of individual hospitalizations

Adding columns with hospitalization number and hospitalization length to
the clinical raw file

```{r}
source("../R/count_sequences_hospitalisation.R")
clinical_raw <- count_hosp(clinical_raw)
```

### Calculating age at hospitalization time

```{r}
# Calculating patient age at the time of visit, assuming the age used is the patients' age at the time of extraction (last discharge date available in the data)
# removing the dots from the ICD codes (if any)
obs_raw_age <- left_join(obs_raw, demo_raw[c("patient_num", "age")], by = c("patient_num")) %>%
  dplyr::mutate( concept_code = gsub("\\.", "",concept_code )) %>%
  dplyr::inner_join(clinical_raw[, c("patient_num", "days_since_admission", "calendar_date")], 
            by = c("patient_num", "days_since_admission"))

# estimate age at each diagnosis
obs_raw_age$age_time_diagnosis <- obs_raw_age$age - floor(as.numeric(as.Date(data_update_date) - as.Date(obs_raw_age$calendar_date, dateFormat)) / 365.25)
```

### Applying inclusion criteria to filter and format the data

We are selecting hospitalizations based on the following criteria:

-   Associated with at least 1 ICD code

-   With a duration of hospitalization spanning over at least one
    consecutive days

-   Starting on or after 2019/01/01

```{r}
obs_filtered_age <- obs_raw_age %>% 
  dplyr::filter(concept_type == 'DIAG-ICD10', 
         days_since_admission >= 0)

clinical_filtered <- clinical_raw %>%
  dplyr::filter( length_hospitalization >= min_hosp_days, 
          cohort  %in% c("AllAdm")) %>%
  dplyr::mutate( date = as.Date( calendar_date),
                 weeks = as.Date(cut( date, breaks = "week")),
                 month = as.Date(cut( date, breaks = "month")),
                 year = format( date, "%Y"), 
                 period = ifelse( date < pandemic_start_date,
                                  "before_pandemic", "during_pandemic"))

if( time_period == "weeks"){
  clinical_filtered$time_p <- clinical_filtered$weeks
}else if(time_period == "days"){
  clinical_filtered$time_p <- clinical_filtered$date
}else if(time_period == "months"){
  clinical_filtered$time_p <- clinical_filtered$month
}

```

```{r}
# Steps necessary to filter rows:
  # - encounters without ICD
  # - ICD diagnosed outside of encounters
  # - patients from the patients table that don't have any encounters matching the criteria
clinical_table <- clinical_filtered %>% 
  dplyr::inner_join( distinct(obs_filtered_age, patient_num, days_since_admission),  
                        by = c("patient_num", "days_since_admission")) %>% 
  dplyr::distinct(patient_num, n_hospitalization) %>% 
  dplyr::inner_join(clinical_filtered, by = c("patient_num", "n_hospitalization"))

# Adding new columns
observation_table <- obs_filtered_age %>% 
  dplyr::inner_join(clinical_table[, c("patient_num", "days_since_admission")], 
                    by = c("patient_num", "days_since_admission"))

demographic_table <- demo_raw %>% 
  dplyr::inner_join(distinct(clinical_table, patient_num), by = "patient_num")

all_codes <- observation_table %>% 
   dplyr::inner_join(select(clinical_table, -calendar_date), 
                     by = c("patient_num", "days_since_admission")) %>% 
   dplyr::inner_join(demographic_table[, c("patient_num", "sex")], 
                     by = "patient_num")
```

## QC
```{r}
print("Starting QC")
source("../R/qc_summary.R")
# summary restricted to patients < 18 years old
qc_summary( input_df = all_codes, obfuscation_threshold = obfuscation, dir.output = dir.output  )

stopifnot(unique(all_codes$cohort) == "AllAdm")
stopifnot(unique(all_codes$in_hospital) == 1)
stopifnot(unique(all_codes$length_hospitalization >= min_hosp_days))
### this does not match
#stopifnot(nrow(all_codes) == nrow(observation_table)) #to check
####
stopifnot(length(unique(all_codes$patient_num)) == length(unique(demographic_table$patient_num)))
stopifnot(length(unique(all_codes$patient_num)) == length(unique(observation_table$patient_num)))
stopifnot(length(unique(all_codes$patient_num)) == length(unique(clinical_table$patient_num)))
stopifnot(nrow(distinct(all_codes, patient_num, n_hospitalization)) == nrow(distinct(clinical_table, patient_num, n_hospitalization)))
stopifnot(nrow(distinct(all_codes, patient_num, days_since_admission)) == nrow(distinct(observation_table, patient_num, days_since_admission)))
```


### Filtering on age less than 18
```{r}
# add the age groups
ageGroups <- read.delim("../public-data/ageGroups.txt", sep="\t",  header = TRUE) 

# Filtering hospitalizations where patient age is in inclusion criteria
observation_table_ado <- filter(observation_table, age_time_diagnosis < 18) %>%
  dplyr::left_join( ageGroups, by = c("age_time_diagnosis" = "age")) 

### print checks
print("Age range before filtering")
print(summary(observation_table$age_time_diagnosis))

print("Age range after filtering")
print(summary(observation_table_ado$age_time_diagnosis))

# Filtering observation tables which patient_num and days_since_admission are still in clinical table after filtering on age
clinical_test <- clinical_table[, c("patient_num", "n_hospitalization", "days_since_admission")] %>% 
  dplyr::inner_join(distinct(observation_table_ado, patient_num, days_since_admission, age_time_diagnosis), 
            by = c("patient_num", "days_since_admission")) %>% 
  dplyr::distinct(patient_num, n_hospitalization, age_time_diagnosis)

clinical_table_ado <- clinical_table %>% 
  dplyr::inner_join(clinical_test,
             by = c("patient_num", "n_hospitalization"))
  
# Filtering observation tables which patient_num are still in clinical table after filtering on age
demographic_table_ado <- demographic_table %>% 
  dplyr::inner_join(distinct(clinical_table_ado, patient_num), by = "patient_num")

# Filtering all_codes by age
all_codes_ado <- all_codes %>% 
   dplyr::filter(age_time_diagnosis <  18)
```

```{r}
stopifnot(unique(all_codes_ado$cohort) == "AllAdm")
stopifnot(unique(all_codes_ado$in_hospital) == 1)
stopifnot(unique(all_codes_ado$length_hospitalization >= min_hosp_days))
### to check
#stopifnot(nrow(all_codes_ado) == nrow(observation_table_ado))
######
stopifnot(length(unique(all_codes_ado$patient_num)) == length(unique(demographic_table_ado$patient_num)))
stopifnot(length(unique(all_codes_ado$patient_num)) == length(unique(observation_table_ado$patient_num)))
stopifnot(length(unique(all_codes_ado$patient_num)) == length(unique(clinical_table_ado$patient_num)))
stopifnot(nrow(distinct(all_codes_ado, patient_num, n_hospitalization)) == nrow(distinct(clinical_table_ado, patient_num, n_hospitalization)))
stopifnot(nrow(distinct(all_codes_ado, patient_num, days_since_admission)) == nrow(distinct(observation_table_ado, patient_num, days_since_admission)))
```

#### QC step: do a summary of the bacterial infection ICD codes present in each site

As output we will generate a table with: the number of observations per
code, number of patients diagnosed with each code and the date range in
which the code was used.

```{r}
#filter the whole dataset to only bacterial infection codes
bacteria_infection_codes_qc <- all_codes_ado %>% 
  filter( concept_code %in% bacterialInfectionCodes$concept_code )

bacteria_infection_codes_qc_output <- bacteria_infection_codes_qc %>%
  group_by( concept_code ) %>%
  dplyr::summarise( distinct_patients = ifelse(length(unique(patient_num)) > obfuscation | isFALSE(obfuscation),
                               length(unique(patient_num)), 
                               0.5),
                    distinct_observations = ifelse(length(patient_num) > obfuscation | isFALSE(obfuscation),
                               length(patient_num), 
                               0.5),                           
                    min_date = min( as.Date( calendar_date, format = dateFormat ) ), 
                    max_date = max( as.Date( calendar_date, format = dateFormat ) ))%>% 
  arrange(desc(distinct_observations))

bacteria_infection_codes_qc_output <- bacteria_infection_codes_qc_output %>%
  left_join( icdCodes, by="concept_code")  %>%
  select( "disorder_group", "description", "concept_code", "distinct_patients", 
          "distinct_observations", "min_date", "max_date")

bacteria_infection_codes_qc_output[1:10, ]

### counts per disorder group and year 
bacteria_infection_codes_qc %>%
  left_join( icdCodes ) %>%
  group_by( disorder_group, year ) %>%
  dplyr::summarise( distinct_patients = ifelse(length(unique(patient_num)) > obfuscation | isFALSE(obfuscation),
                               length(unique(patient_num)), 
                               0.5),
                    distinct_observations = ifelse(length(patient_num) > obfuscation | isFALSE(obfuscation),
                               length(patient_num), 
                               0.5),                           
                    min_date = min( as.Date( calendar_date, format = dateFormat ) ), 
                    max_date = max( as.Date( calendar_date, format = dateFormat ) ))%>% 
  arrange(disorder_group, year )
  
```

### Add the bacterial infection ICD code description and filter

```{r message=FALSE, warning=FALSE}
# Getting site name, will be used later in the analysis
site <- unique(as.character(demo_raw$siteid))


all_codes_desc <- all_codes_ado %>% 
  mutate( concept_code = gsub("[.]", "", concept_code)) %>%
  left_join( icdCodes, by=c("concept_code") ) %>%
  mutate(icd_code_category = ifelse(concept_code %in% icdCodes$concept_code, 
                               "bacterial", 
                               "others")) %>%
  dplyr::select( patient_num, sex, age_time_diagnosis, concept_type, concept_code, calendar_date,
                 in_hospital, n_hospitalization, length_hospitalization, date, weeks, month, year,
                 period, time_p, disorder_group, description, icd_code_category )

all_codes_bacterial <- all_codes_desc %>% 
  dplyr::filter(concept_code %in% icdCodes$concept_code)
```

# Results

## Admission

First calculation: total number of patients, matching the inclusion
criteria, admitted on one day (without filtering by any disease
subtype). Summed up over one week, or one month depending on the time
unit chosen. Not filtered on age.

```{r}
new_hospitalizations <- clinical_table %>%
  dplyr::group_by(patient_num, n_hospitalization) %>%
  dplyr::slice(which.min(time_p)) %>% #probably need to remove this
  dplyr::filter( in_hospital == 1 ) %>%
  dplyr::group_by( time_p ) %>%
  dplyr::summarise(count = ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5)) %>% 
  dplyr::ungroup()

source("../R/admission_plot_count.R")
nh <- admission_plot_count(df = new_hospitalizations, 
                     x = "time_p",
                     y = "count", 
                     title = paste0("New admissions (per ", time_period,")"), 
                     y_title = "Patient Count")
nh
```

## New admissions age range 0-17
```{r}
new_hospitalizations_ado <- clinical_table_ado %>%
  dplyr::group_by(patient_num, n_hospitalization) %>%
  dplyr::slice(which.min(time_p)) %>%
  dplyr::filter( in_hospital == 1 ) %>%
  dplyr::group_by( time_p ) %>%
  dplyr::summarise(count = ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5)) %>% 
  dplyr::ungroup()


nh_ado <- admission_plot_count(df = new_hospitalizations_ado, 
                     x = "time_p",
                     y = "count", 
                     title = paste0("New admissions (per ", time_period, ")"), 
                     y_title = "Patient Count")+
    labs( subtitle = "(age range < 18)")

nh_ado
```

## Patient count filtered on bacterial infection disorders

### New admissions

```{r}
count_icd_bacterial <- all_codes_bacterial %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( time_p ) %>%
  summarise(count_bacterial =  ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5)) %>%
  mutate( period = ifelse( time_p < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

count_icd <- all_codes_desc %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( time_p ) %>%
  summarise(count_icd =  ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5)) %>%
  mutate( period = ifelse( time_p < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

count_icd <- count_icd %>%
  left_join(count_icd_bacterial, 
            by = c("time_p", "period")) %>% 
  replace_na(list(count_bacterial = 0))

count_icd$percentage_bacterial <- 100*count_icd$count_bacterial / count_icd$count_icd


thpd_bacterialCount <- count_icd %>%
  pivot_longer(names_to = "counts", cols=c(count_bacterial, count_icd)) %>%
  mutate( counts = ifelse( counts == "count_bacterial", "Bacterial", "Total")) %>%
  ggplot(aes(x = time_p, y = value, fill = counts, color = counts)) +
  geom_point() +
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  scale_fill_manual(values = cbPalette) +
  scale_color_manual(values = cbPalette) +
  labs(y = "Counts",
       x = paste0("Date (by ", time_period,")"),
       title = paste0("Per ", time_period , " patient counts with bacterial infection related ICD codes")) + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=period), colour= "black", size = 0.5)

thpd_bacterialCount
```

### Percentages: patients with bacterial infection condition / patients without bacterial infection condition

```{r}
all_patients <- unique( all_codes_desc[, c("patient_num", "time_p")])
patients_with_bacterial_conditions <- unique( all_codes_bacterial[, c("patient_num", "time_p")] )
patients_without_bacterial_conditions <- setdiff(all_patients,patients_with_bacterial_conditions)

patients_without_bacterial_conditions_counts <- patients_without_bacterial_conditions %>%
  group_by( time_p ) %>%
  summarise(count_no_bacterial_patients =  ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5)) %>%
  mutate( period = ifelse( time_p < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic"))


patients_with_bacterial_conditions_counts <-  patients_with_bacterial_conditions %>%
  group_by( time_p ) %>%
  summarise(count_bacterial_patients =  ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5)) %>%
  mutate( period = ifelse( time_p < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic"))

ratios_patients_with_without_bacterial <- patients_without_bacterial_conditions_counts %>%
  full_join( patients_with_bacterial_conditions_counts, by=c("time_p", "period")) %>%
  mutate( ratio = count_bacterial_patients/count_no_bacterial_patients, 
          percentage = 100 * count_bacterial_patients/(count_no_bacterial_patients + count_bacterial_patients))

```

```{r}
ratios_patients_with_without_bacterial %>%
  ggplot(aes(x = time_p, y = percentage, color = period)) +
  geom_point() +
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  scale_fill_manual(values = cbPalette) +
  scale_color_manual(values = cbPalette) +
  labs(y = "Percentage",
       x = paste0("Date (by ", time_period,")"),
       title = paste0("Percentage patient with vs total population ( per ", time_period,")")) +
  guides(color = guide_legend(title="Patient diagnoses types"))
```

## Interrupted Time-Series Analyses

```{r}
# Time series analysis 
patient_count_bacterial_period_bacterial <- ratios_patients_with_without_bacterial %>%
  filter(time_p > as.Date(cut( start_date_plots, breaks = time_period)) &
           time_p < as.Date(cut( end_date_plots, breaks = time_period))) %>%
  mutate(time = seq_along(time_p),
         month_year = format(time_p, "%m")
  )

start_clear_period <- as.Date("2020-03-15")
end_clear_period <- as.Date("2020-05-15")
patient_count_bacterial_period_bacterial_clear <- patient_count_bacterial_period_bacterial %>%
  mutate( count_no_bacterial_patients = ifelse(time_p < as.Date(cut( start_clear_period, breaks = time_period)) |
                               time_p > as.Date(cut( end_clear_period, breaks = time_period)),
                             count_no_bacterial_patients,
                             NA), 
          count_no_bacterial_patients = ifelse(time_p < as.Date(cut( start_clear_period, breaks = time_period)) |
                               time_p > as.Date(cut( end_clear_period, breaks = time_period)),
                             count_no_bacterial_patients,
                             NA), 
          ratio = ifelse(time_p < as.Date(cut( start_clear_period, breaks = time_period)) |
                           time_p > as.Date(cut( end_clear_period, breaks = time_period)),
                         ratio,
                         NA),
          percentage = ifelse(time_p < as.Date(cut( start_clear_period, breaks = time_period)) |
                           time_p > as.Date(cut( end_clear_period, breaks = time_period)),
                         percentage,
                         NA)
  )
```

```{r, its count based}
ts_linear_count <- lm(count_bacterial_patients ~ period * time, patient_count_bacterial_period_bacterial)
ts_seasonal_count <- lm(count_bacterial_patients ~ period*time + harmonic(month_year, 1, 12), patient_count_bacterial_period_bacterial)
```

```{r, its percentage based}
ts_linear_percent <- lm(percentage ~ period * time, patient_count_bacterial_period_bacterial)
ts_seasonal_percent <- lm(percentage ~ period*time + harmonic(month_year, 1, 12), patient_count_bacterial_period_bacterial)
```


### ITS: patient counts, no clearance period, with seasonality effect

```{r}
source("../R/time_series_analysis_plotting.R")

time_series_analysis_plotting(ts_seasonal_count,
                              patient_count_bacterial_period_bacterial,
                              "count_bacterial_patients",
                              clearance_period = FALSE) +
  labs(title = "Interrupted Time-Series Analysis: Percentage of encounters with bacterial infection ICD codes",
       subtitle = "With seasonality effect",
       x = time_period,
       y = "Count")
```

### ITS: bacterial percentage, no clearance period, with seasonality effect

```{r}
time_series_analysis_plotting(ts_seasonal_percent,
                              patient_count_bacterial_period_bacterial,
                              "percentage",
                              clearance_period = FALSE) +
  labs(title = "Interrupted Time-Series Analysis: Percentage of encounters with bacterial infection ICD codes",
       subtitle = "Without seasonality effect",
       x = time_period,
       y = "Percentage")
```

## Bacterial infection conditions aggregating by subcategories

### New admissions: count

```{r}
count_disorder_group <- all_codes_bacterial %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( time_p, disorder_group ) %>%
  summarise(count_dg =  ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5)) %>%
  mutate( period = ifelse( time_p < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

dg <- count_disorder_group %>%  
  ggplot(aes(x = time_p, y= count_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = time_period,
       y = "Patient Count",
       title = paste0("Per ", time_period, " patient counts with bacterial infection related ICD codes"), 
       subtitle = "Grouped by bacterial infection ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 10),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dg
```

### New admissions: percentage

```{r}
# estimate the counts
count_icd_all <- all_codes_desc %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( time_p ) %>%
  summarise(count_icd =  ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5)) %>%
  mutate( period = ifelse( time_p < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )


# join the total with the disorder group count to estimate the percentage
perc_disorder_group <- count_icd_all %>%
  left_join(count_disorder_group, 
            by = c("time_p", "period")) %>% 
  replace_na(list(count_dg = 0))

perc_disorder_group$percentage_dg <- 100*perc_disorder_group$count_dg / perc_disorder_group$count_icd

dgPerc <- perc_disorder_group %>%  
  ggplot(aes(x = time_p, y= percentage_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = time_period,
       y = "Patient (%)",
       title = paste0("Percentage of patients per ", time_period,"with bacterial infection related ICD codes"), 
       subtitle = "Grouped by bacterial infection ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 10),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dgPerc
```


## bacterial infection conditions, dichotomized on patients' sex

### Count

```{r}
# counts per time period and sex
patients_hospitalized_agg_sex <- all_codes_bacterial %>%
  filter(date < end_date_plots &
         date >= start_date_plots & 
           sex %in% c("female", "male")) %>%
    group_by( time_p, sex ) %>%
  summarise(count_sex =  ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5))

patients_hospitalized_agg_sex %>%
  ggplot(aes(x = time_p, y = count_sex, fill = sex)) +
  geom_bar(stat="identity", position = "dodge")+
  scale_fill_manual(values = cbPalette) +
  labs(y = "Counts",
       x = time_period,
       title = paste0("Patient counts per ", time_period, " aggregated by sex"),
       subtitle = "Per Sex") + 
  theme(legend.position = "bottom") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=sex), colour= "black", size = 0.5)
```

### Percentage

```{r}
##percentage
total_patients_bacterial <- all_codes_bacterial %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( time_p ) %>%
  summarise(count =  ifelse(n_distinct(patient_num) > obfuscation | isFALSE(obfuscation),
                               n_distinct(patient_num), 
                               0.5))

patients_hospitalized_agg_sex_perc <- total_patients_bacterial %>%
  left_join( patients_hospitalized_agg_sex, by = c("time_p")) %>% 
  replace_na(list(count_sex = 0))

patients_hospitalized_agg_sex_perc$percentage <- 100*patients_hospitalized_agg_sex_perc$count_sex/patients_hospitalized_agg_sex_perc$count

patients_hospitalized_agg_sex_perc %>%
  ggplot(aes(x = time_p, y = percentage, fill = sex)) +
  geom_bar(stat="identity", position = "dodge")+
  scale_fill_manual(values = cbPalette) +
  labs(y = "Percentage ",
       x = time_period,
       title = paste0("Patient (%) per ", time_period," aggregated by sex"),
       subtitle = "Per Sex") + 
  theme(legend.position = "bottom") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=sex), colour= "black", size = 0.5)
```

## Table 1

```{r}
source("../R/ttest2.R")

age_by_period <- all_codes_bacterial %>%
  distinct(patient_num, age_time_diagnosis, period) %>% 
  dplyr::group_by(period) %>%
  dplyr::summarise( mean = mean( age_time_diagnosis ),
                    sd = sd( age_time_diagnosis ),
                    count = n_distinct(patient_num))


age_test <- t.test2(m1 = age_by_period[[1, "mean"]],
                    m2 = age_by_period[[2, "mean"]],
                    s1 = age_by_period[[1, "sd"]],
                    s2 = age_by_period[[2, "sd"]],
                    n1 = age_by_period[[1, "count"]],
                    n2 = age_by_period[[2, "count"]]) %>%
  `[[`("p-value")
```

```{r}
sex <- all_codes_bacterial %>%
  dplyr::distinct(patient_num, sex) %>% 
  dplyr::group_by( sex ) %>%
  dplyr::summarise( count = n_distinct(patient_num) ) %>%
  dplyr::mutate( count = ifelse( count > obfuscation, count, obfuscation * 0.5),
                 total = sum( count ), percentage = round( count/total*100, 2)  )

sex_by_period <- all_codes_bacterial %>%
  dplyr::distinct(patient_num, period, sex) %>% 
  group_by(period, sex ) %>%
  summarise(count = n_distinct(patient_num)) %>%
  group_by(period, .add=TRUE) %>%
  mutate( count = ifelse( count > obfuscation, count, obfuscation * 0.5),
          percentage=round(count/sum( count )*100, 2)) %>%
  replace_na(list(male = 0, female = 0))


sex_test <- sex_by_period %>%
  select(-percentage) %>%
  pivot_wider(names_from = sex, values_from = count) %>%
  ungroup() %>%
  select(male, female) %>%
  chisq.test() %>%
  `[[`("p.value")
```

```{r}
summary_diagnosis <- all_codes_bacterial %>%
  dplyr::distinct( patient_num, description, period, weeks, concept_code ) %>%
  dplyr::group_by( concept_code, description, period ) %>%
  dplyr::count( patient_num ) %>%
  dplyr::tally(name = "count") %>%
  dplyr::mutate(count = ifelse( count > obfuscation, count, obfuscation * 0.5)) %>%
  dplyr::arrange( desc(count) ) %>%
  dplyr::ungroup()

summary_diagnosis_test <- summary_diagnosis %>%
  tidyr::pivot_wider(names_from = period,
                     values_from = count) %>%
  #select(late_pandemic, early_pandemic) %>%
  select(during_pandemic) %>%
  #tidyr::replace_na(list(late_pandemic = 0, early_pandemic = 0)) %>%
  tidyr::replace_na(list(during_pandemic = 0)) %>%
  chisq.test() %>%
  `[[`("p.value")

```

```{r}
summary_disorder_group <- all_codes_bacterial %>%
  dplyr::group_by( disorder_group ) %>%
  dplyr::count( patient_num ) %>%
  dplyr::tally(name = "count") %>%
  dplyr::mutate(count = ifelse( count > obfuscation, count, obfuscation * 0.5)) %>%
  dplyr::arrange( desc( count ))

summary_disorder_group_by_period <- all_codes_bacterial %>%
  dplyr::distinct( patient_num, disorder_group, period, weeks ) %>%
  dplyr::group_by( period, disorder_group ) %>%
  summarise(count = n_distinct(patient_num)) %>%
  group_by(period, .add=TRUE) %>%
  mutate(count = ifelse( count > obfuscation, count, obfuscation * 0.5),
         percentage = count/sum( count )*100)

summary_disorder_group_by_period_test <- summary_disorder_group_by_period %>%
  pivot_wider(id_cols = disorder_group, names_from = period, values_from = c(count, percentage)) %>%
  mutate(across(where(is.numeric), ~replace_na(.x, replace = 0))) %>%
  #select(count_early_pandemic, count_late_pandemic) %>%
  select(count_during_pandemic) %>%
  chisq.test() %>%
  `[[`("p.value")

```

```{r}
format_counts <- function(count, percentage) {
  glue::glue("{count} ({percentage} %)", count = count, percentage = percentage)
}


age_table1 <- age_by_period %>% 
  mutate(result = glue::glue("{mean} (sd: {sd})", mean = round(mean, 2), sd = round(sd, 2))) %>% 
  select(result, period) %>% 
  pivot_wider( names_from = period, values_from = result ) %>%
  mutate(name = "Age")


sex_table1 <- sex_by_period %>%
  bind_rows(
    sex_by_period %>%
      group_by(period) %>%
      dplyr::summarise(sex = "Total", count = sum(count), percentage = sum(percentage))
  ) %>%
  mutate(result = format_counts(count, percentage)) %>%
  select(-c(count, percentage)) %>%
  pivot_wider( names_from = period, values_from = result ) %>%
  rename(name = sex)

disorder_table1 <- summary_disorder_group_by_period %>%
  arrange(desc(count)) %>% 
  bind_rows(
    dplyr::summarise(., disorder_group="Total", across(where(is.numeric), sum))
  ) %>%
  mutate(percentage = round(percentage, 2)) %>% 
  mutate(result = format_counts(count, percentage)) %>%
  select(-c(count, percentage)) %>%
  pivot_wider( names_from = period, values_from = result ) %>%
  replace_na( list(during_pandemic = "0 (0 %)")) %>%
  rename(name = disorder_group)
```

```{r}
list_tests <- c("Sex" = sex_test,
                "Age" = age_test,
                "Diagnoses" = summary_diagnosis_test,
                "Disorder groups" = summary_disorder_group_by_period_test
)

list_table1 <- list(
  "Sex" = sex_table1,
  "Age" = age_table1,
  "Disorder groups" = disorder_table1)


tests <- list_tests %>%
  data.frame() %>%
  round(2)
names(tests) <- "pvalue"
tests["Category"] <- row.names(tests)

table1 <- list_table1 %>%
  lapply(function(df) mutate(df, across(.fns = as.character))) %>%
  dplyr::bind_rows(.id = "Category") %>%
  dplyr::left_join(tests, by = "Category")


table1 %>%
  group_by(Category) %>%
  mutate(pvalue = ifelse(duplicated(pvalue, fromLast = TRUE), "", as.character(pvalue))) %>%
  ungroup() %>%
  mutate(Category = "") %>%
  mutate(across(.cols = c(before_pandemic, during_pandemic), .fns = replace_na, "0")) %>%
  rename_with(str_to_title) %>%
  rename_with(sub, pattern = "_", replacement = " ") %>%
  mutate(across(.fns = str_to_title)) %>%
  mutate(across(.fns = sub, pattern = "_", replacement = " ")) %>%
  kable( booktabs = T) %>%
  kableExtra::kable_styling(latex_options = "striped") %>%
  kableExtra::group_rows(index = setNames(rle(table1$Category)[[1]], rle(table1$Category)[[2]]))
```
